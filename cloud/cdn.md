## CDN Content Delivery Network 内容分发网络

构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率

- 优势
  - 加速：基于 CDN 各节点，就近获取内容
  - 降低负载：基于 CDN 缓存，减少源站的访问
  - 成本低：费用成本、部署成本
  - 可扩展性强：基于边缘计算
- 功能
  - 缓存 解决跨运营商和跨地域访问的问题，访问延时大大降低
  - 降低应用服务器负载 大部分请求在 CDN 边缘节点完成，CDN 起到了分流作用，
  - 自定义缓存过期时间规则 支持配置自定义资源的缓存过期时间规则, 支持指定路径或者文件名后缀方式, 支持 Header 输出缓存过期时间
  - 自定义 header 头 如 Access-Control-Allow-Origin: * 以实现跨域
  - 自定义页面 支持设置404、403、503、504等页面
  - 页面优化 去除HTML页面页面冗余内容如注释以及重复的空白符
  - 智能压缩 对静态文件类型进行压缩, 有效减少用户传输内容大小
  - 访问控制 Refer防盗链、IP 黑/白名单等
  - 支持 HTTPS
  - 统计分析、日志管理
  - 人工智能服务：识图、鉴黄等

## 架构

- 边缘节点 分布在各个地方的各个数据中心的节点
  - 数目比较多，但是每个集群规模比较小，不可能缓存下来所有东西，因而可能无法命中
- 区域节点
  - 数据会更多，命中的概率也就更大
- 中心节点
  - 规模更大，缓存数据更多
  - 如果还不命中，就只好回源网站访问了

![原理](../_static/cdn.jpg "Optional title")

## 域名解析配置

- CNAME 相当于起别名，跳转到 CDN
- CDN 内部通过注册一个三级域名指向内部做负载均衡
- web.com 权威 DNS 服务器，设置一个 CNAME 别名，指向域名`  www.web.cdn.com `，返回给本地 DNS 服务器
- 本地 DNS 服务器访问 web.cdn.com 权威 DNS 服务器， 服务器设置一个 CNAME，指向 CDN 网络的全局负载均衡器
- 全局负载均衡器会为用户选择一台合适的缓存服务器提供服务，选择的依据包括：
  - 根据用户 IP 地址，判断哪一台服务器距用户最近
  - 用户所处的运营商
  - 根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需的内容
  - 查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力

## 获取模式

- 拉取 静态页面
  - 内容的分发往往采取拉取的方式，也即当发现未命中的时候，再去上一级进行拉取
- 推送 支持流媒体协议
  - 相当于一个代理，从上一级缓存读取内容，转发给用户。
  - 由于流媒体往往是连续的，因而可以进行预先缓存的策略，也可以预先推送到用户的客户端。
  - 流媒体数据量大，如果出现回源，压力会比较大，所以往往采取主动推送的模式，将热点数据主动推送到边缘节点
  - 预处理服务
    - 在文件分发之前，经过一定处理
    - 将视频转换为不同的码流，以适应不同的网络带宽的用户需求
    - 对视频进行分片，降低存储压力，也使得客户端可以选择使用不同码率加载不同的分片。就是常见的，“我要看超清、标清、流畅等”。
  - 防盗链
    - 根据 HTTP 头 Referer 字段,相对比较容易破解，所以还需要配合其他的机制
    - 时间戳防盗链
      - 客户端取出当前时间戳，访问资源及其路径，连同加密字符串通过签名算法得到一个字符串，然后生成一个下载链接，带上这个签名字符串和截止时间戳去访问 CDN
      - 在 CDN 服务端，根据取出过期时间，和当前 CDN 节点时间进行比较，确认请求是否过期。然后 CDN 服务端有了资源及路径，时间戳，以及约定的加密字符串，根据相同的签名算法计算签名，如果匹配则一致，访问合法，才会将资源返回给客户

## 动态 CDN

- 生鲜超市模式|边缘计算的模式
  - 既然数据是动态生成的，所以数据的逻辑计算和存储，相应的放在边缘节点
  - 定时从源数据那里同步存储的数据，然后在边缘进行计算得到结果。
  - 就像对生鲜的烹饪是动态的，没办法事先做好缓存，因而将生鲜超市放在你家旁边，既能够送货上门，也能够现场烹饪，也是边缘计算的一种体现。
  - 物流中的做独立仓储
- 冷链运输模式|路径优化的模式
  - 数据不是在边缘计算生成的，而是在源站生成的，但是数据的下发则可以通过 CDN 的网络，对路径进行优化
  - 因为 CDN 节点较多，能够找到离源站很近的边缘节点，也能找到离用户很近的边缘节点。
  - 中间的链路完全由 CDN 来规划，选择一个更加可靠的路径，使用类似专线的方式进行访问。
  - 物流中优化路径
  - 比如复用连接 保证每次动态请求到达时。连接都已经建立了，不必临时三次握手或者建立过多的连接，增加服务器的压力

## 应用

- cdn 只支持（DC）外网服务，不支持内网同步

### 缓存存储

- 自定义缓存时间
  - 动态文件（eg：php | jsp | asp），建议设置缓存时间为 0s，即不缓存
  - 若动态文件例如 php 文件内容更新频率较低，推荐设置较短缓存时间
- 基于 URL 维度进行 Hash 生成唯一字符，基于该字符进行缓存获取与存储
- 静态资源更新
  - 除使用 URL 维度外，
  - 依靠附加参数形式，进行 CDN 缓存“更新”
  - 这个“更新”实际是静态资源生成新的 CDN 缓存。
  - 维度增加也同样意味着 CDN 缓存命中率的降低
- CDN 服务商会在资源请求的 Response Headers 中输出一些涉及缓存命中、CDN 节点、Hash字符、过期时间等信息

### 刷新预热|清理 CDN 缓存

- 通过提供文件 URL 或目录方式，强制 CDN 节点回源拉取最新的文件
- 将指定内容主动预热到 CDN 节点上，用户首次访问即可直接命中缓存，降低源站压力
- 一般大规模迁移的时候，会使用到

### 图片 WEBP 原理

- 开启 CDN Header - Accept 回源
- 获取 Request Headers 中 Accept 中包含 image/webp（即支持webp）
- 通过边缘计算方式，通过源站获取对应素材转换为 webp 格式，并存储至对应 CDN 节点
- CDN 输出

## 图书

- cdn技术详解

## Tool

- [ReplaceGoogleCDN](https://github.com/justjavac/ReplaceGoogleCDN):♋️ 一个 Chrome 插件：将 Google CDN 替换为国内
- [cdnjs](https://github.com/cdnjs/cdnjs):The #1 free and open source CDN built to make life easier for developers. <https://cdnjs.com>
- [staticdn](https://cdn.con.sh/)
- [Filebase](https://filebase.com/)
