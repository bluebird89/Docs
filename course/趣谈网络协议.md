## [趣谈网络协议](https://time.geekbang.org/column/intro/85) 刘超
#course #network 

- 内容以下主要架构，未涉及部分在本页面
  - [network](../network/network) ^46c576
  - [TCP/IP](../network/tcp_ip)
- 协议三要素
  - 语法 内容要符合一定的规则和格式
  - 语义 内容要代表某种意义
  - 顺序
- 分层
  - **只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层**
  - 下层是上层实现的基础，下层要包含上层的语义
  - 完整数据包都要经过 MAC 传输
- IP vs MAC 二层会依赖四层，四层也会依赖二层

## DC

- 每一个连接都要考虑高可用
- 服务器
  - 服务器被放在一个个机架 Rack
  - 至少两个网卡、两个网线插到 TOR 交换机上，
  - 网卡绑定 bond 两个网卡要工作得像一张网卡一样
    - 需要服务器和交换机都支持 LACP（Link Aggregation Control Protocol）
      - 互相通信，将多个网卡聚合称为一个网卡，多个网线聚合成一个网线，在网线之间可以进行负载均衡，也可以为了高可用作准备。
- 接入层 Access Layer 一层 TOR 交换机
  - TOR（Top Of Rack）交换机  放在机架顶端的交换机将服务器连接起来，可以互相通信
- 汇聚层交换机 Aggregation Layer 多个机架连接在一起，对性能的要求更高，带宽也更大
- 交换机高可用
  - 部署两个接入交换机、两个汇聚交换机
    - 服务器和两个接入交换机都连接，接入交换机和两个汇聚都连接，当然这样会形成环，所以需要启用 STP 协议，去除环，但是这样两个汇聚就只能一主一备
  - 堆叠 多个交换机形成一个逻辑的交换机
    - 服务器通过多根线分配连到多个接入层交换机上，接入层交换机多根线分别连接到多个交换机上，并且通过堆叠的私有协议，形成双活的连接方式
    - 由于对带宽要求更大，而且挂了影响也更大，所以两个堆叠可能就不够了，可以就会有更多的，比如四个堆叠为一个逻辑的交换机。
- POD（Point Of Delivery）|可用区（Available Zone）
  - 汇聚层将大量计算节点相互连接在一起，形成一个集群。集群里面，服务器之间通过二层互通
 
- 节点数目再多的时候，一个可用区放不下，用**核心交换机**将多个可用区连在一起
  - 核心交换机吞吐量更大，高可用要求更高，肯定需要堆叠
  - 往往仅仅堆叠，不足以满足吞吐量，因而还是需要部署多组核心交换机。
  - 核心和汇聚交换机之间为了高可用，也是全互连模式的
- 核心和汇聚交换机环路问题
  - 不同可用区在不同二层网络，分配不同网段。汇聚和核心之间通过三层网络互通，二层都不在一个广播域里面，不会存在二层环路的问题。三层有环是没有问题的，只要通过路由协议选择最佳的路径就可以了
    - 二层是广播域，会存在“循环广播风暴”，所以二层不能有环路
    - 核心层和汇聚层之间通过内部的路由协议 OSPF，找到最佳的路径进行访问，而且还可以通过 ECMP 等价路由，在多个路径之间进行负载均衡和高可用
    
- 云计算、大数据，集群规模非常大，而且都要求在一个二层网络里面。
  - 二层互连从汇聚层上升为核心层，也即在核心以下，全部是二层互连，全部在一个广播域里面，这就是常说的大二层（局域网组网）
  - 如果大二层横向流量不大，核心交换机数目不多，可以做堆叠，但是如果横向流量很大，仅仅堆叠满足不了，就需要部署多组核心交换机，而且要和汇聚层进行全互连。
  - 由于堆叠只解决一个核心交换机组内的无环问题，而组之间全互连，还需要其他机制进行解决
  - 如果是 STP，那部署多组核心无法扩大横向流量的能力，因为还是只有一组起作用。
  - 大二层就引入 TRILL（Transparent Interconnection of Lots of Link）多链接透明互联协议
    - 基本思想 二层环有问题，三层环没有问题，那就把三层的路由能力模拟在二层实现。
    - 运行 TRILL 协议的交换机称为 RBridge，具有路由转发特性的网桥设备，只不过这个路由是根据 MAC 地址来的，不是根据 IP 来的。
    - Rbridage 之间通过链路状态协议运作。通过它可以学习整个大二层的拓扑，知道访问哪个 MAC 应该从哪个网桥走；还可以计算最短的路径，也可以通过等价的路由进行负载均衡和高可用性。
    - TRILL 协议在原来 MAC 头外面加上自己的头，以及外层的 MAC 头。TRILL 头里面的 Ingress RBridge，有点像 IP 头里面的源 IP 地址，Egress RBridge 是目标 IP 地址，这两个地址是端到端的，在中间路由的时候，不会发生改变。而外层的 MAC，可以有下一跳的 Bridge，就像路由的下一跳，也是通过 MAC 地址来呈现的一样。
    - 对于大二层的广播包，也需要通过分发树的技术来实现。STP 是将一个有环的图，通过去掉边形成一棵树，而分发树是一个有环的图形成多棵树，不同的树有不同的 VLAN，有的广播包从 VLAN A 广播，有的从 VLAN B 广播，实现负载均衡和高可用。
- 在核心交换上面，往往会挂一些安全设备，例如入侵检测、DDoS 防护等等。这是整个数据中心的屏障，防止来自外来的攻击。核心交换机上往往还有负载均衡器
- 边界路由器 Border Router 在数据中心的边界,数据中心的入口和出口也是路由器
  - 为了高可用,会连接多个运营商网络
  - 多线 BGP
    - 数据中心往往就是路由协议中的自治区域（AS）
    - 数据中心里面机器要想访问外面网站，数据中心里面也是有对外提供服务的机器，都可以通过 BGP 协议，获取内外互通的路由信息
- 整个数据中心的网络结构
	- 三层网络结构 接入层、汇聚层、核心层
	- 南北流量 从外到内或者从内到外，对应到图里，就是从上到下，从下到上，上北下南
	- 东西流量 但是随着云计算和大数据的发展，节点之间的交互越来越多，例如大数据计算经常要在不同的节点将数据拷贝来拷贝去，这样需要经过交换机，使得数据从左到右，从右到左，左西右东
	- 叶脊网络（Spine/Leaf）解决东西流量的问题
		- 叶子交换机（leaf），直接连接物理服务器。L2/L3 网络的分界点在叶子交换机上，叶子交换机之上是三层网络。
		- 脊交换机（spine switch），相当于核心交换机。叶脊之间通过 ECMP 动态选择多条路径。脊交换机现在只是为叶子交换机提供一个弹性的 L3 路由网络。南北流量可以不用直接从脊交换机发出，而是通过与 leaf 交换机并行的交换机，再接到边界路由器出去。
- 运维人员通过vpn连入机房网络，再通过堡垒机访问服务器或网络设备

![数据中心架构](../_static/dc_arch.png)
![数据中心大集群架构](../_static/dc_large.png)
![TRILL 帧结构](../_static/trill_packet.png)
![整个数据中心的网络](../_static/dc_arch_final.png)
![叶脊网络](../_static/spine.png)

## vpn Virtual Private Network 虚拟专用网

- 通过隧道技术在公众网络上仿真一条点到点的专线
- 将一个机构的多个数据中心通过隧道的方式连接起来，让机构感觉在一个数据中心里面
- 通过利用一种协议来传输另外一种协议的技术,涉及三种协议：乘客协议(本地化)=>隧道协议(路径)=>承载协议(真实数据)

### IPsec VPN 基于 IP 协议的安全隧道协议

- 根据封装网络包的格式分两种协议
	- AH（Authentication Header）只能进行数据摘要 ，不能实现数据加密
	- ESP（Encapsulating Security Payload）能够进行数据加密和数据摘要
- 加密算法
- 摘要算法
- DH 算法
	- 一个比较巧妙的算法
	- 客户端和服务端约定两个公开的质数 p 和 q，然后客户端随机产生一个数 a 作为自己的私钥，服务端随机产生一个 b 作为自己的私钥，
	- 客户端可以根据 p、q 和 a 计算出公钥 A，服务端根据 p、q 和 b 计算出公钥 B，然后双方交换公钥 A 和 B。
	- 客户端和服务端可以根据已有的信息，各自独立算出相同的结果 K，就是对称密钥
-  IKE 组件  用于 VPN 双方进行对称密钥的交换
-  SA（Security Association）组件 VPN 双方连接进行维护
- 过程
	- 建立 IKE 自己的 SA
		- 这个 SA 用来维护一个通过身份认证和安全保护的通道，为第二个阶段提供服务。
		- 通过 DH（Diffie-Hellman）算法计算出一个对称密钥 K。这个过程，对称密钥从来没有在通道上传输过，只传输了生成密钥的材料，通过这些材料，截获的人是无法算出的。
	- 建立 IPsec SA
		- 在这个 SA 里面，双方会生成一个随机对称密钥 M，由 K 加密传给对方，使用 M 进行双方接下来通信的数据
		- 对称密钥 M 是有过期时间的，过一段时间，重新生成一次，防止被破解。
		- 内容
			- SPI（Security Parameter Index），用于标识不同的连接
			- 双方商量好的加密算法、哈希算法和封装模式
			- 生存周期，超过这个周期，就需要重新生成一个 IPsec SA，重新生成对称密钥。
	- 可以打包封装传输
		- 左面 原始的 IP 包，在 IP 头里面，会指定上一层的协议为 TCP。
		- ESP 要对 IP 包进行封装，因而 IP 头里面的上一层协议为 ESP。
		- ESP 正文里面，ESP 的头部有双方商讨好的 SPI，以及这次传输的序列号
		- 接下来全部是加密的内容。
	- 隧道出来后解封装
		- 通过对称密钥进行解密，解密后在正文最后，指明了里面的协议是什么
		- 如果是 IP，则需要先解析 IP 头，然后解析 TCP 头
- 有了 IPsec VPN 之后，客户端发送的明文 IP 包，都会被加上 ESP 头和 IP 头，在公网上传输，由于加密，可以保证不被窃取，到对端后，去掉 ESP 的头，进行解密。
- 这种点对点的基于 IP 的 VPN，能满足互通的要求，但是速度往往比较慢，这是由底层 IP 协议的特性决定的。
	- IP 不是面向连接的，是尽力而为的协议，每个 IP 包自由选择路径，到每一个路由器，都自己去找下一跳，丢了就丢了，靠上一层 TCP 的重发来保证可靠性。
	- 因为 IP 网络从设计的时候，就认为是不可靠的，所以即使同一个连接，也可能选择不同的道路，这样的好处是，一条道路崩溃的时候，总有其他的路可以走。当然，带来的代价就是，不断的路由查找，效率比较差。
- 另一种技术协议 ATM
	- 和 IP 协议的不同在于，是面向连接的
	- 传输之前先建立一个连接，形成一个虚拟的通路，一旦连接建立，所有的包都按照相同的路径走，不会分头行事
	- 好处 不需要每次都查路由表的，虚拟路径已经建立，打上标签，后续包跟着走就是了，不用像 IP 包一样，每个包都思考下一步怎么走，都按相同的路径走，这样效率会高很多。
	- 一旦虚拟路径上某个路由器坏了，则这个连接就断了，什么也发不过去了，因为其他的包还会按照原来的路径走，都掉坑里了，不会选择其他的路径走
	- 虽然没有成功，但其屏弃繁琐的路由查找，改为简单快速的标签交换，将具有全局意义的路由表改为只有本地意义的标签表，这些都可以大大提高一台路由器的转发功力。
- 多协议标签交换 MPLS，Multi-Protocol Label Switching
	- 在原始 IP 头之外，多了 MPLS 头，里面可以打标签
	-  二层头里面，类型字段 0x0800 表示 IP，0x8847 表示 MPLS Label
	-  MPLS 头 结构
		- 标签值占 20 位
		- 3 位实验位
		- 1 位栈底标志位，表示当前标签是否位于栈底了。这样就允许多个标签被编码到同一个数据包中，形成标签栈。
		- 8 位 TTL 存活时间字段，如果标签数据包的出发 TTL 值为 0，那么该数据包在网络中的生命期被认为已经过期了。
	- 标签交换路由器（LSR，Label Switching Router）
		- 转发标签的路由设备，认这个标签，并且能够根据这个标签转发，有两个表格
			- 传统的 FIB，也即路由表
			- LFIB，标签转发表
		- 在 MPLS 区域中间，使用标签进行转发
		- 非 MPLS 区域，使用普通路由转发
		- 在边缘节点上，需要有能力将对于普通路由转发变成对于标签的转发。
		- LSP 通过标签转换而建立的路径 
			- 要访问 114.1.1.1，在边界上查找普通路由，发现马上要进入 MPLS 区域了，进去了对应标签 1，于是在 IP 头外面加一个标签 1
			- 在区域里面，标签 1 要变成标签 3
			- 标签 3 到达出口边缘，将标签去掉，按照路由发出
			- 在一条 LSP 上，沿数据包传送方向，相邻 LSR 分别叫上游 LSR（upstream LSR）和下游 LSR（downstream LSR）。
		- LDP（Label Distribution Protocol） 动态的生成标签的协议
			- 标签分发 通过 LSR 的交互，互相告知去哪里应该打哪个标签
			- 往往是从下游开始的
			- 如果有一个边缘节点发现自己的路由表中出现了新的目的地址，它就要给别人说，能到达一条新的路径了。
			- 如果此边缘节点存在上游 LSR，并且尚有可供分配的标签，则该节点为新的路径分配标签，并向上游发出标签映射消息，其中包含分配的标签等信息。
			- 收到标签映射消息的 LSR 记录相应的标签映射信息，在其标签转发表中增加相应的条目。此 LSR 为它的上游 LSR 分配标签，并继续向上游 LSR 发送标签映射消息。
			- 当入口 LSR 收到标签映射消息时，在标签转发表中增加相应的条目。这时，就完成了 LSP 的建立。
	- MPLS VPN 中，网络中的路由器分类
		- CE（Customer Edge）：客户网络与 PE 相连接的边缘设备
		- PE（Provider Edge）：运营商网络与客户网络相连的边缘网络设备
		- P（Provider）：特指运营商网络中除 PE 之外的其他运营商网络设备
		- P Router 之间，使用标签是没有问题的，因为都在运营商的管控之下，对于网段，路由都可以自己控制
		- 客户接入网络，客户地址重复
			- BGP 协议处理 PE 路由器之间使用特殊的 MP-BGP 来发布 VPN 路由，在相互沟通的消息中，在一般 32 位 IPv4 的地址之前加上一个客户标示的区分符用于客户地址的区分，这种称为 VPN-IPv4 地址族，这样 PE 路由器会收到如下的消息，机构 A 的 192.168.101.0/24 应该往这面走，机构 B 的 192.168.101.0/24 则应该去另外一个方向。
			- 路由表处理 在 PE 上，可以通过 VRF（VPN Routing&Forwarding Instance）建立每个客户一个路由表，与其它 VPN 客户路由和普通路由相互区分。可以理解为专属于客户的小路由器。远端 PE 通过 MP-BGP 协议把业务路由放到近端 PE，近端 PE 根据不同的客户选择出相关客户的业务路由放到相应的 VRF 路由表中。
		- VPN 报文转发采用两层标签方式
			- 第一层（外层）标签在骨干网内部进行交换，指示从 PE 到对端 PE 的一条 LSP。VPN 报文利用这层标签，可以沿 LSP 到达对端 PE
			- 第二层（内层）标签在从对端 PE 到达 CE 时使用，在 PE 上，通过查找 VRF 表项，指示报文应被送到哪个 VPN 用户，或者更具体一些，到达哪一个 CE。这样，对端 PE 根据内层标签可以找到转发报文的接口。

![IPsec 包结构](../_static/ipsec_frame_struct.jpg)
![MPLS VPN 网络](../_static/mpls_net.png)


## 连接


将具有全局意义的路由表改为只有本地意义的标签表

sdn最大的意义在于让网络功能可编程

```sh
ovs-vsctl set port first_br qos=@newqos -- \
--id=@newqos create qos type=linux-htb other-config:max-rate=10000000 queues=0=@q0,1=@q1,2=@q2 -- \
--id=@q0 create queue other-config:min-rate=3000000 other-config:max-rate=10000000 -- \
--id=@q1 create queue other-config:min-rate=1000000 other-config:max-rate=10000000 -- \
--id=@q2 create queue other-config:min-rate=6000000 other-config:max-rate=10000000
```

RPC 调用，应该用二进制还是文本类？其实文本的最大问题是，占用字节数目比较多。比如数字 123，其实本来二进制 8 位就够了，但是如果变成文本，就成了字符串 123。如果是 UTF-8 编码的话，就是三个字节；如果是 UTF-16，就是六个字节。同样的信息，要多费好多的空间，传输起来也更加占带宽，时延也高。

### GRE

穿透

## 云计算

云平台中搭建一个电商-> BGP 路由广播-> DNS 域名解析->客户看商品图片->下单

《TCP/IP illustrated TCP/IP 详解》Rechard Stevens

## 容器

## 微服务

Amazon S3 在2008年7月就遇到过，单bit反转导致了一次严重线上事故，所以他们吸取教训加了 check sum。见<http://status.aws.amazon.com/s3-20080720.html>
