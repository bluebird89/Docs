---
date updated: '2021-07-22T01:28:32+08:00'

---

# [趣谈网络协议](https://time.geekbang.org/column/intro/85) 刘超

- 内容以下主要架构，未涉及部分在本页面
  - [network](../network/network) ^46c576
  - [TCP/IP](../network/tcp_ip)
- 协议三要素
  - 语法 内容要符合一定的规则和格式
  - 语义 内容要代表某种意义
  - 顺序
- 分层
  - **只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层**
  - 下层是上层实现的基础，下层要包含上层的语义
  - 完整数据包都要经过 MAC 传输
- IP vs MAC 二层会依赖四层，四层也会依赖二层

## DC

- 每一个连接都要考虑高可用
- 服务器
  - 服务器被放在一个个机架 Rack
  - 至少两个网卡、两个网线插到 TOR 交换机上，
  - 网卡绑定 bond 两个网卡要工作得像一张网卡一样
    - 需要服务器和交换机都支持 LACP（Link Aggregation Control Protocol）
      - 互相通信，将多个网卡聚合称为一个网卡，多个网线聚合成一个网线，在网线之间可以进行负载均衡，也可以为了高可用作准备。
- 接入层 Access Layer 一层 TOR 交换机
  - TOR（Top Of Rack）交换机  放在机架顶端的交换机将服务器连接起来，可以互相通信
- 汇聚层交换机 Aggregation Layer 多个机架连接在一起，对性能的要求更高，带宽也更大
- 交换机高可用
  - 部署两个接入交换机、两个汇聚交换机
    - 服务器和两个接入交换机都连接，接入交换机和两个汇聚都连接，当然这样会形成环，所以需要启用 STP 协议，去除环，但是这样两个汇聚就只能一主一备
  - 堆叠 多个交换机形成一个逻辑的交换机
    - 服务器通过多根线分配连到多个接入层交换机上，接入层交换机多根线分别连接到多个交换机上，并且通过堆叠的私有协议，形成双活的连接方式
    - 由于对带宽要求更大，而且挂了影响也更大，所以两个堆叠可能就不够了，可以就会有更多的，比如四个堆叠为一个逻辑的交换机。
- POD（Point Of Delivery）|可用区（Available Zone）
  - 汇聚层将大量计算节点相互连接在一起，形成一个集群。集群里面，服务器之间通过二层互通
- 节点数目再多的时候，一个可用区放不下，用核心交换机将多个可用区连在一起
``` tracker
searchType: tag
searchTarget: tagName
folder: /
startDate:
endDate:
line:
    title: "Line Chart"
    xAxisLabel: Date
    yAxisLabel: Value
```
  - 核心交换机吞吐量更大，高可用要求更高，肯定需要堆叠
  - 往往仅仅堆叠，不足以满足吞吐量，因而还是需要部署多组核心交换机。
  - 核心和汇聚交换机之间为了高可用，也是全互连模式的
- 核心和汇聚交换机环路问题
  - 不同可用区在不同二层网络，分配不同网段。汇聚和核心之间通过三层网络互通，二层都不在一个广播域里面，不会存在二层环路的问题。三层有环是没有问题的，只要通过路由协议选择最佳的路径就可以了
    - 二层是广播域，会存在“循环广播风暴”，所以二层不能有环路
    - 核心层和汇聚层之间通过内部的路由协议 OSPF，找到最佳的路径进行访问，而且还可以通过 ECMP 等价路由，在多个路径之间进行负载均衡和高可用。
- 云计算、大数据，集群规模非常大，而且都要求在一个二层网络里面。
  - 二层互连从汇聚层上升为核心层，也即在核心以下，全部是二层互连，全部在一个广播域里面，这就是常说的大二层（局域网组网）
  - 如果大二层横向流量不大，核心交换机数目不多，可以做堆叠，但是如果横向流量很大，仅仅堆叠满足不了，就需要部署多组核心交换机，而且要和汇聚层进行全互连。
  - 由于堆叠只解决一个核心交换机组内的无环问题，而组之间全互连，还需要其他机制进行解决
  - 如果是 STP，那部署多组核心无法扩大横向流量的能力，因为还是只有一组起作用。
  - 大二层就引入 TRILL（Transparent Interconnection of Lots of Link）多链接透明互联协议
    - 基本思想 二层环有问题，三层环没有问题，那就把三层的路由能力模拟在二层实现。
    - 运行 TRILL 协议的交换机称为 RBridge，具有路由转发特性的网桥设备，只不过这个路由是根据 MAC 地址来的，不是根据 IP 来的。
    - Rbridage 之间通过链路状态协议运作。通过它可以学习整个大二层的拓扑，知道访问哪个 MAC 应该从哪个网桥走；还可以计算最短的路径，也可以通过等价的路由进行负载均衡和高可用性。
    - TRILL 协议在原来 MAC 头外面加上自己的头，以及外层的 MAC 头。TRILL 头里面的 Ingress RBridge，有点像 IP 头里面的源 IP 地址，Egress RBridge 是目标 IP 地址，这两个地址是端到端的，在中间路由的时候，不会发生改变。而外层的 MAC，可以有下一跳的 Bridge，就像路由的下一跳，也是通过 MAC 地址来呈现的一样。
- 边界路由器 Border Router 在数据中心的边界,数据中心的入口和出口也是路由器
  - 为了高可用,会连接多个运营商网络
  - 多线 BGP
    - 数据中心往往就是路由协议中的自治区域（AS）
    - 数据中心里面机器要想访问外面网站，数据中心里面也是有对外提供服务的机器，都可以通过 BGP 协议，获取内外互通的路由信息

![数据中心架构](../_static/dc_arch.png)
![数据中心大集群架构](../_static/dc_large.png)
![TRILL 帧结构](../_static/trill_packet.png)

![[trill_packet.png]]
![[#^46c576]]

## 连接

运维人员通过vpn连入机房网络，再通过堡垒机访问服务器或网络设备

将具有全局意义的路由表改为只有本地意义的标签表

sdn最大的意义在于让网络功能可编程

```sh
ovs-vsctl set port first_br qos=@newqos -- \
--id=@newqos create qos type=linux-htb other-config:max-rate=10000000 queues=0=@q0,1=@q1,2=@q2 -- \
--id=@q0 create queue other-config:min-rate=3000000 other-config:max-rate=10000000 -- \
--id=@q1 create queue other-config:min-rate=1000000 other-config:max-rate=10000000 -- \
--id=@q2 create queue other-config:min-rate=6000000 other-config:max-rate=10000000
```

RPC 调用，应该用二进制还是文本类？其实文本的最大问题是，占用字节数目比较多。比如数字 123，其实本来二进制 8 位就够了，但是如果变成文本，就成了字符串 123。如果是 UTF-8 编码的话，就是三个字节；如果是 UTF-16，就是六个字节。同样的信息，要多费好多的空间，传输起来也更加占带宽，时延也高。

### IPSec

### GRE

穿透

## 云计算

云平台中搭建一个电商-> BGP 路由广播-> DNS 域名解析->客户看商品图片->下单

《TCP/IP illustrated TCP/IP 详解》Rechard Stevens

## 容器

## 微服务

Amazon S3 在2008年7月就遇到过，单bit反转导致了一次严重线上事故，所以他们吸取教训加了 check sum。见<http://status.aws.amazon.com/s3-20080720.html>
